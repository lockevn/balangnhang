<?php // $Id: mod.html,v 1.4 2007/01/05 03:17:40 mark-nielsen Exp $
/**
 * This page defines the form to create or edit an instance of this module
 * It is used from /course/mod.php.  The whole instance is available as $form.
 *
 * @author Mark Nielsen
 * @version $Id: mod.html,v 1.4 2007/01/05 03:17:40 mark-nielsen Exp $
 * @copyright http://www.gnu.org/copyleft/gpl.html GNU Public License
 * @package gallery
 **/
 
require_once($CFG->dirroot.'/mod/gallery/lib.php');

// check to make sure global settings are correct
if (!gallery_check_config()) {
    if (isadmin()) {
        notify(get_string('gallerynotconfiguredadmin', 'gallery', $CFG->wwwroot));
    } else {
        notify(get_string('gallerynotconfigured', 'gallery'));
    }
    print_simple_box_end();
    print_footer();
    exit();
}

gallery_init();

// Check that form variables have been initialised
if (!isset($form->name)) {
    $form->name = '';
}
if (!isset($form->albumid)) {
    $form->albumid = 0;
    $form->title = '';
    $form->summary = '';
    $form->description = '';
    $form->keywords = '';
} else {
    // most information is stored in gallery, retrieve it
    list($ret, $album) = GalleryCoreApi::loadEntitiesById($form->albumid);
    $form->title = $album->gettitle();
    $form->summary = $album->getsummary();
    $form->description = $album->getdescription();
    $form->keywords = $album->getkeywords();
    gallery_r();
}
if (!isset($form->permissions)) {
    $form->permissions = gallery_decode_permissions($CFG->gallery_studentpermissions);
} else {
    $form->permissions = gallery_decode_permissions($form->permissions);
}

// For linking to other albums
$rootalbums         = array();
$linkedalbums       = get_records_select_menu('gallery', "albumid != $form->albumid", '', 'id, albumid');
list($ret, $rootid) = GalleryCoreApi::getPluginParameter('module', 'core', 'id.rootAlbum');

if (!$ret) {
    // Get the root album
    list($ret, $rootalbum) = GalleryCoreApi::loadEntitiesById($rootid);
    if (!$ret) {
        // Load all children of root album
        list($ret, $subitemids) = GalleryCoreApi::fetchChildItemIds($rootalbum);
        if (!$ret) {
            foreach ($subitemids as $subitemid) {
                list($ret, $subitem) = GalleryCoreApi::loadEntitiesById($subitemid);
                if (!$ret) {
                    // If it is an album and it is not already linked to a MGM instance, then add it
                    if ($subitem->getentitytype() == 'GalleryAlbumItem' and !in_array($subitem->getId(), $linkedalbums)) {
                        $rootalbums[$subitem->getId()] = $subitem->gettitle();
                    }
                }
            }
        }
    }
}
gallery_r();

?>

<!-- barrowed from resource mod, thanks! ;) -->
<script language="javascript" type="text/javascript">
    function showhide (id, set) {
        divobj = document.getElementById(id);
        butobj = document.getElementById(id+'button');
        prefobj = document.getElementById(id+'pref');
        if (set == true) {
            if (prefobj.value == '1') {
                divobj.style.display = 'block';
                butobj.value = '<?php print_string("hidesettings") ?>';
            } else {
                divobj.style.display = 'none';
                butobj.value = '<?php print_string("showsettings") ?>...';
            }
        } else {
            if (prefobj.value == '1') {
                divobj.style.display = 'none';
                butobj.value = '<?php print_string("showsettings") ?>...';
                prefobj.value = '0';
            } else {
                divobj.style.display = 'block';
                butobj.value = '<?php print_string("hidesettings") ?>';
                prefobj.value = '1';
            }
        }
    }
</script>

<form name="form" method="post" action="mod.php">
<table cellpadding="5" align="center">
<tr valign="top">
    <td align="right"><b><?php  print_string("name") ?>:</b></td>
    <td>
        <input type="text" name="name" size="30" value="<?php  p($form->name) ?>">
    </td>
</tr>
<tr valign="top">
    <td align="right"><b><?php  print_string('linkedalbum', 'gallery') ?>:</b></td>
    <td>
        <?php 
            choose_from_menu($rootalbums, 'albumid', $form->albumid, get_string('createnewalbum', 'gallery'));
            helpbutton('linkedalbum', get_string('linkedalbum', 'gallery'), 'gallery');
        ?>
    </td>
</tr>
<tr valign="top">
    <td align="right"><b><?php  print_string('albumtitle', 'gallery') ?>:</b></td>
    <td>
        <input type="text" name="title" size="30" value="<?php  p($form->title) ?>">
    </td>
</tr>
<tr valign="top">
    <td align="right"><b><?php  print_string('albumsummary', 'gallery') ?>:</b></td>
    <td>
        <input type="text" name="summary" size="30" value="<?php  p($form->summary) ?>">
    </td>
</tr>
<tr valign="top">
    <td align="right"><b><?php print_string('albumdescription', 'gallery')?>:</b><br /><br />
     <?php
        helpbutton('writing', get_string('helpwriting'), 'moodle', true, true);
        echo '<br />';
        helpbutton('questions', get_string('helpquestions'), 'moodle', true, true);
        echo '<br />';
        if ($usehtmleditor) {
           helpbutton('richtext', get_string('helprichtext'), 'moodle', true, true);
        } else {
           emoticonhelpbutton('form', 'intro');
        }   
        echo '<br />';
      ?>
    </td>
    <td>
        <?php print_textarea($usehtmleditor, 20, 50, 680, 400, 'description', $form->description); ?>
    </td>
</tr>
<tr valign="top">
    <td align="right"><b><?php  print_string('albumkeywords', 'gallery') ?>:</b></td>
    <td>
        <input type="text" name="keywords" size="30" value="<?php  p($form->keywords) ?>">
        <?php helpbutton('keywords', get_string('albumkeywords', 'gallery'), 'gallery', true) ?>
    </td>
</tr>
<?php if ($CFG->gallery_permissions) { ?>
<tr>
    <td align="right" valign="top"><b><?php print_string('studentpermissions', 'gallery') ?>:</b></td>
    <td>
        <input type="button" value="hide settings" id="permissionsettingsbutton" onclick="javascript: return showhide('permissionsettings');" />
        <input type="hidden" name="permissionsettingspref" id="permissionsettingspref" 
               value="<?php echo get_user_preferences('gallery_permissionsettingspref', 0); ?>" />
        <?php helpbutton('studentpermissions', get_string('studentpermissions', 'gallery'), 'gallery', true) ?>

        <div id="permissionsettings">
            <table align="left">
                <tr valign="top">
                    <td colspan="2">
                        <?php
                            $i = 0;
                            $teacherpermissions = gallery_decode_permissions($CFG->gallery_teacherpermissions);
                            foreach (gallery_get_permissions() as $permission => $text) {
                                if (!$teacherpermissions[$permission]) {
                                    continue;  // only allow teachers to assign permissions that s/he has
                                }
                                if (isset($form->permissions[$permission]) and $form->permissions[$permission] == 1) {
                                    $check = 'checked="checked" ';
                                } else {
                                    $check = '';  // off by default
                                }
                                
                                echo "<input type=\"checkbox\" name=\"permissions[$permission]\" value=\"1\" id=\"permission$i\" $check/>
                                     <label for=\"permission$i\">$text</label><br />";
                                $i++;
                            }
                        ?>
                    </td>
                </tr>
            </table>
        </div>
    </td>
</tr>
<?php } ?>
<!-- The following line for Moodle 1.5 prints the visibility setting form element -->
<?php print_visible_setting($form); ?>
<!-- and if your module uses groups you would also have -->
<?php //print_groupmode_setting($form); ?>

</table>

<script language="javascript" type="text/javascript">
    showhide('permissionsettings', true);
</script>

<!-- These hidden variables are always the same -->
<input type="hidden" name="oldalbumid"    value="<?php  p($form->albumid) ?>" />
<input type="hidden" name="course"        value="<?php  p($form->course) ?>" />
<input type="hidden" name="sesskey"       value="<?php  p($form->sesskey) ?>" />
<input type="hidden" name="coursemodule"  value="<?php  p($form->coursemodule) ?>" />
<input type="hidden" name="section"       value="<?php  p($form->section) ?>" />
<input type="hidden" name="module"        value="<?php  p($form->module) ?>" />
<input type="hidden" name="modulename"    value="<?php  p($form->modulename) ?>" />
<input type="hidden" name="instance"      value="<?php  p($form->instance) ?>" />
<input type="hidden" name="mode"          value="<?php  p($form->mode) ?>" />
<center><input type="submit" value="<?php  print_string("savechanges") ?>" /></center>

</form>
